%%  Thinking Forth style 
%%  this style recreates the original appearence of TF
%%  Copyright (C) 2004  Bernd Paysan, Anton Ertl

%%  This program is free software; you can redistribute it and/or modify
%%  it under the terms of the GNU General Public License as published by
%%  the Free Software Foundation; either version 2 of the License, or
%%  (at your option) any later version.

%%  This program is distributed in the hope that it will be useful,
%%  but WITHOUT ANY WARRANTY; without even the implied warranty of
%%  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
%%  GNU General Public License for more details.

%%  You should have received a copy of the GNU General Public License
%%  along with this program; if not, write to the Free Software
%%  Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.

%%  This program is alternatively licensed under the creative common
%%  license http://creativecommons.org/licenses/by-nc-sa/2.0/, i.e.
%%  requires attribution, non-commercial use, and shared-alike.
%%  If you don't like that, take the GPL as above.

\typeout{Thinking Forth Style [13oct04py]}

%% Some basic things

\makeatletter

%% options

\newif\ifeightyfour
\newif\ifofour
\eightyfourfalse
\ofourfalse

\DeclareOption{1984}{\eightyfourtrue}
\DeclareOption{2004}{\ofourtrue}
\ExecuteOptions{}
\ProcessOptions

%% only chapters have section numbers

\setcounter{secnumdepth}{0}

%% If there's something not correctly typesetted, use \fixme

\newcommand{\fixme}[1]{{\tiny$\triangleright$\marginpar{\tiny$\triangleleft$!!#1}}}

%% labels and references

\newcommand{\labelsect}[1]{\label{sect-#1}}
\newcommand{\labelfig}[1]{\label{fig-#1}}
\newcommand{\figref}[1]{\ref{fig-#1}}
\newcommand{\fig}[1]{Figure~\figref{#1}}
\newcommand{\Fig}[1]{Figure~\figref{#1}}
\newcommand{\sect}[1]{Section~\ref{sect-#1}}
\newcommand{\Sect}[1]{Section~\ref{sect-#1}}
\newcommand{\Chapmark}[1]{{\def\@currentlabel{\refchapter}\label{chapter-#1}}}
\newcommand{\Chap}[1]{Chapter \ref{chapter-#1}}
\newcommand{\App}[1]{\ref{chapter-#1}}

% Hurenkinder und Schusterjungen verbieten

\clubpenalty=10000          % No orphans, keine Schusterjungen
\widowpenalty=10000         % No widows, keine Hurenkinder
\brokenpenalty=10000        % No broken words between pages
\doublehyphendemerits=10000 % No double hyphens

%% Images

%%\w{eps,tex}fig*{label}{caption}
% *:
% ''  missing figure
% 'a' figure here
% 't' figure on top of page
% 'b' figure on bottom of page
% 'pp' figure on page of figures
% 'x' image on separate page
% 'xx' small image on separate page (make sure no other image lands there)
% tex includes a latex file, should be a minipage there, only available
%     in t and b flavour

\newcommand{\wepsfig}[2]{\begin{figure}[hhhh]
\caption{#2}\labelfig{#1}eps file missing\end{figure}}

\newcommand{\wepsfiga}[2]{
\begin{figure}[hhhh]
\caption{#2}
\vspace{1ex}
\centerline{\includegraphics{#1}}\vspace{1ex}
\labelfig{#1}
\end{figure}
}
\newcommand{\wepsfigt}[2]{
\begin{figure*}[tttt]
\caption{#2}\par
\vspace{1ex}
\centerline{\includegraphics{#1}}\vspace{1ex}
\labelfig{#1}
\end{figure*}
}
\newcommand{\wepsfigpp}[2]{
\begin{figure*}[pppp]
\caption{#2}\par
\vspace{1ex}
\centerline{\includegraphics{#1}}\vspace{1ex}
\labelfig{#1}
\end{figure*}
}
\newcommand{\wepsfigb}[2]{
\begin{figure*}[bbbb]
\caption{#2}\par
\vspace{1ex}
\centerline{\includegraphics{#1}}\vspace{1ex}
\labelfig{#1}
\end{figure*}
}
\newcommand{\wepsfigx}[1]{
\begin{figure*}[pppp]
\vspace{1ex}
\centerline{\includegraphics{#1}}\vspace{1ex}
\labelfig{#1}
\end{figure*}
}
\newcommand{\wepsfigxx}[1]{
\begin{figure*}[pppp]
\vspace{20ex}
\centerline{\includegraphics{#1}}\vspace{20ex}
\labelfig{#1}
\end{figure*}
}
\newcommand{\wepsfigp}[2]{
\begin{figure*}[pppp]
\vspace{1ex}
\centerline{\includegraphics{#1}}\vspace{1ex}
\begin{center}{\emph{#2}}\end{center}
\vspace{1ex}
\label{img-#1}
\end{figure*}
}
\newcommand{\wtexfigt}[2]{
\begin{figure*}[tttt]
\caption{#2}
\smallskip
\input{#1}
\labelfig{#1}
\end{figure*}
}
\newcommand{\wtexfigb}[2]{
\begin{figure*}[bbbb]
\caption{#2}
\smallskip
\input{#1}
\labelfig{#1}
\end{figure*}
}

%% footnotes

\renewcommand\thefootnote{\fnsymbol{footnote}} 
\renewcommand\thempfootnote{*} 

%% Only caption and label for figures with code

\newcommand\verbfig[2]{
\caption{#2}
\labelfig{#1}
}

%% There's no bold typewriter in Computer Modern.
%% Emulate with printing several times, slightly moving

\newcommand{\poorbf}[1]{%
\kern-.25pt\hbox to 0.25pt{#1\hss}%
\raise0.25pt\hbox to 0pt{#1\hss}%
\lower0.25pt\hbox to 0pt{#1\hss}%
\hbox to 0.25pt{#1\hss}%
#1\kern-0.25pt}

%% line for separating is blacker than LaTeX default

\newcommand{\blackline}[1]{\hrule height 1pt\nopagebreak\vspace{#1}}

%% allow pretty big top fractions for floating placement

\renewcommand\topfraction{.95}
\renewcommand\bottomfraction{.5}
%\renewcommand\floatpagefraction{.05}

%% TIP environment

\newenvironment{tip}{
\ifhmode\unskip\unskip \par\bigskip\else\bigskip\fi
\advance\linewidth-2.5em
\noindent\hbox to 2.5em{\hss}\begin{minipage}{\linewidth}
\blackline{1.5ex}
TIP\\[1ex]\small
}{\par\normalsize\vspace{1.5ex}\blackline{0pt}
\end{minipage}\\[\bigskipamount]
\advance\linewidth2.5em
}

%\newenvironment{tip}{\list{}{
%\parsep\z@ \@plus\p@\small}%
%\samepage\setlength{\@topsep}{2pt}%
%\hbox{\hbox to\leftmargin{}%
%\hbox to \linewidth{\leaders\hrule\@height 1pt\hfill}}%
%\vspace{1ex}
%\item\relax{\normalsize TIP}\nopagebreak\\[1ex]\nopagebreak}%
%{\endlist\nopagebreak\kern-\baselineskip%
%\hbox{\hbox to\leftmargin{}%
%\hbox to \linewidth{\leaders\hrule\@height 1pt\hfill}\medskip}
%\goodbreak}

%% quotation environment for TF

\newenvironment{tfquot}
               {\list{}{\listparindent 0em%
                        \itemindent    \listparindent
                        \parsep        1ex \@plus\p@\small}%
                \item\relax}
               {\endlist}

\newenvironment{interview}
               {\ifhmode\unskip\unskip\par\medskip\else\medskip\fi
		 \list{}{\listparindent 0pt%
                        \itemindent    0pt
                        \leftmargin    0pt
			\topsep        0pt
                        \parsep        0.5ex \@plus\p@}%
		\medbreak\blackline{\medskipamount}\nopagebreak
                \item\relax}
               {\samepage\par\blackline{0pt}\medskip\endlist\goodbreak}


%\pointto{box}
\newcommand{\pointto}[1]{\raisebox{-1.8ex}[0pt][0pt]{\makebox[0pt][l]{\texttt{\^{ }}}}#1}

\def\hy{\penalty 0\allowhyphens}

%\fwbox{text} %like fbox, but does not create a wider box
\newcommand{\fwbox}[1]{\framebox[\width]{#1}}
\def\boxto#1#2{\setbox0\hbox{#1}\hbox to \wd0{\hss #2\hss}}


%!! in the '94 edition (and probably the original) inline Forth words are
%set in a roman font; if you change \forth to do this, make sure that > and
%< get the correct glyphs
%\forth{words} %used within text paragraphs
%\code text was originally also set in roman font
%1984 edition uses fat romand for Forth words
\ifeightyfour
\newcommand{\forth}[1]{\textbf{#1}}
\newcommand{\code}[1]{\textbf{#1}}
\else
%1994 edition uses teletype for Forth words
\newcommand{\forth}[1]{\texttt{#1}}
\newcommand{\code}[1]{\texttt{#1}}
\fi

{\catcode`\|0\catcode`\\12%
|gdef|bs{\}}

\newcommand{\chapternum}[1]{}

%\lstloadaspects{labels}
%\lstset{language=Forth,basicstyle=\ttfamily,keywordstyle=\bfseries,%
%basewidth=0.5em,frame=tlbr,frameround=tttt,%
%fancyvrb=true% set this to true if you want fancyvrb use
%}

%% chapter style, chapters without name like Preface are chapter*

\newcommand\HUGE{\@setfontsize\HUGE{33}{38}}
\newcommand\THUGE{\@setfontsize\HUGE{65}{70}}
\newcounter{appendix}

\def\@makechapterhead#1{{\HUGE
%    \sffamily
    \fontfamily{phv}\selectfont\bfseries\slshape
  \vbox{\advance\textwidth1em\hrule \@height 3pt
    \vspace*{0.2ex}\hbox to \textwidth{\wordchapter\hss}\vspace*{0.2ex}
    \hrule \@height 3pt}
  \vspace*{100pt}
  \hbox{\hbox to .1\linewidth{}
  \vbox{\hsize.9\linewidth
    \parindent\z@\hyphenpenalty 10000\raggedright
  #1}}
  \vspace*{1em plus 1fill}
  \pagebreak
  \vspace*{1.7in}\blackline{10pt}
}\stepcounter{appendix}}
\def\@makeschapterhead#1{{\HUGE
%    \sffamily
    \fontfamily{phv}\selectfont\bfseries\slshape
    \parindent 0pt
  \vbox{{\advance\textwidth1em\hrule \@height 3pt \@width\textwidth}%
    \vspace*{0.2ex}{\advance\textwidth-1em\sloppy\uppercase{#1}}\vspace*{0.2ex}%
	    {\advance\textwidth1em\hrule \@height 3pt \@width\textwidth}}%
  \vspace*{100pt}}}

\def\enumchap#1{\ifcase#1\or One\or Two\or Three\or Four\or
Five\or Six\or Seven\or Eight\or Nine\or Ten\fi}
\def\wordchapter{\MakeUppercase{\enumchap\c@chapter}}
\def\refchapter{\enumchap{\c@chapter}}

%% environments that go into TOC

\renewenvironment{theindex}
               {\if@twocolumn
                  \@restonecolfalse
                \else
                  \@restonecoltrue
                \fi
                \columnseprule \z@
                \columnsep 35\p@
                \twocolumn[\@makeschapterhead{\indexname}]%
                \@mkboth{\MakeUppercase\indexname}%
                        {\MakeUppercase\indexname}%
		\addcontentsline{toc}{chapter}{\indexname}
                \thispagestyle{plain}\parindent\z@
                \parskip\z@ \@plus .3\p@\relax
                \let\item\@idxitem}
               {\if@restonecol\onecolumn\else\clearpage\fi}

%% appendix stuff

\def\epilog{\gdef\wordchapter{EPILOGUE}}
\renewcommand\appendix{\par
  \setcounter{appendix}{1}%
  \setcounter{section}{0}%
  \gdef\thechapter{\@Alph\c@appendix}%
  \gdef\refchapter{Appendix \@Alph\c@appendix}%
  \gdef\wordchapter{APPENDIX \thechapter}%
  \gdef\chapter@upper\relax}

%% headings style

%\def\iffloatpage#1#2{\if@fcolmade #1\else #2\fi}

\def\ps@headings{\let\@mkboth\markboth
  \def\@oddhead{}
  \def\@evenhead{}
  \def\@evenfoot{\if@fcolmade\else
      \hss\vbox{\hsize\textwidth
      \hbox to \textwidth{\hbox to 0pt{\hss\hbox to .66in{\sf\bfseries\thepage\hss}}%
        \vrule height0pt depth3.2pt width 0pt%
        {\kern-.33in\small\sf\leftmark}\hfil}}\fi}
  \def\@oddfoot{\if@fcolmade\else
      \hss\vbox{\hsize\textwidth
      \hbox to \textwidth{%
        \hfil\vrule height0pt depth3.2pt width 0pt{{\small\sf\leftmark}\kern-.33in}%
        \hbox to 0pt{\hbox to .66in{\hss\sf\bfseries\thepage}\hss}}}\fi}
  \def\chaptermark##1{\markboth{##1}{##1}}%
  \def\sectionmark##1{\markright{##1}}%
  \def\subsectionmark##1{\markright{##1}}%
  \def\subsubsectionmark##1{}%
}

\ps@headings
\def\ps@plain{\ps@empty}

%% section marking

\newif\ifsectionlabel
\sectionlabelfalse

\newcounter{sectionlr}

\def\@setrefpp#1{\ifx#1\relax0\else#1\fi}
\def\pagerefpp#1{\expandafter\@setrefpp\csname r@#1\endcsname}
\def\labelpp#1{\@bsphack%
  \protected@write\@auxout{}%
         {\string\newlabel{#1}{\arabic{page}}}%
  \@esphack}

\newcounter{@sectionlrpage}
\def\setlrcounter#1{%
\setcounter{@sectionlrpage}{\ifsectionlabel #1\else\arabic{page}\fi}}
\def\raggedlr{\noindent
\expandafter\setlrcounter{%
\expandafter\pagerefpp{s@ctionlr-\arabic{sectionlr}}}%
\ifodd\c@@sectionlrpage\raggedleft\else\raggedright\fi
\stepcounter{sectionlr}}
\def\sectionlab#1#2{\global\@namedef{r@#1}{#2}}
\def\raggedr{\noindent
\expandafter\setlrcounter{%
\expandafter\pagerefpp{s@ctionlr-\arabic{sectionlr}}}%
\raggedright
\stepcounter{sectionlr}}

%% original Thinking Forth placement
\ifeightyfour
\let\sectionlr\raggedlr
\let\subsectionlr\raggedr
\let\subsubsectionlr\raggedr
\else
%% more consistent:
\let\sectionlr\raggedlr
\let\subsectionlr\raggedlr
\let\subsubsectionlr\raggedlr
\fi
%%

\def\section#1{\@startsection{section}{1}{-.66in}{2.5ex plus 1ex 
    minus .2ex}{2ex plus .2ex}{\Large\sf\bfseries\slshape}[#1]{\sectionlr #1\kern-.66in}}
\def\subsection#1{\@startsection{subsection}{2}{0in}{2ex plus 1ex
    minus .2ex}{1.5ex \relax}{\large\sf\bfseries}[#1]{\subsectionlr #1\kern0in}}
\def\subsubsection#1{\@startsection{subsubsection}{3}{0in}{2ex plus 1ex
    minus .2ex}{1.5ex \relax}{\sf\bfseries}[#1]{\subsubsectionlr #1\kern0in}}

%% indentation

\parindent=2.5em
\DefineVerbatimEnvironment{Code}{Verbatim}{xleftmargin=2.5em}
\def\dontbreak{\@nobreaktrue}

%% list indentation

\def\@listi{\leftmargin\leftmargini
            \parsep 2\p@ \@plus2\p@ \@minus\p@
            \topsep 8\p@ \@plus2\p@ \@minus4\p@
            \itemsep2\p@ \@plus2\p@ \@minus\p@}
\let\@listI\@listi
\@listi
\def\@listii {\leftmargin\leftmarginii
              \labelwidth\leftmarginii
              \advance\labelwidth-\labelsep
              \topsep    4\p@ \@plus2\p@ \@minus\p@
              \parsep    0\p@ \@plus\p@  \@minus\p@
              \itemsep   \parsep}

%% screen environment

\newcounter{screen}
\DefineVerbatimEnvironment{Screen}{Verbatim}{frame=single,framesep=3pt,%
label=[{\rm Screen \# \arabic{screen}\stepcounter{screen}}],%
labelposition=topline,numbers=left,firstnumber=0,numbersep=3pt,%
samepage=true,xleftmargin=0em,xrightmargin=0em}

%% caption style

\long\def\@makecaption#1#2{%
  \vskip\abovecaptionskip
  \sbox\@tempboxa{{\bf #1:} {\it #2}}%
  \ifdim \wd\@tempboxa >\hsize
    \textbf{#1:} \emph{#2}\par
  \else
    \global \@minipagefalse
    \hb@xt@\hsize{\hfil\box\@tempboxa\hfil}%
  \fi
  \vskip\belowcaptionskip}

%% description style

\renewcommand*\descriptionlabel[1]{\hspace{2.5em}
                                \normalfont\itshape #1}

%% table of contents style

\def\@upperskip{1.5em \@plus\p@}
\def\@lowerskip{1.0em \@plus\p@}

\def \doappendix#1{%
  \if#1A\normalfont\setcounter{tocdepth}{0}
  \gdef\@upperskip{0pt}\gdef\@lowerskip{0pt} Appendix A\quad\fi
                                       \if#1D\normalfont Appendix D\quad\fi
  \if#1B\normalfont Appendix B\quad\fi \if#1E\normalfont Appendix E\quad\fi
  \if#1C\normalfont Appendix C\quad\fi \if#1F\normalfont Appendix F\quad\fi
  }

\renewcommand\numberline[1]{\doappendix{#1}}
\renewcommand*\l@chapter[2]{%
  \ifnum \c@tocdepth >\m@ne
    \addpenalty{-\@highpenalty}%
    \vskip\@upperskip
    \setlength\@tempdima{1.5em}%
    \begingroup
      \leavevmode
      \hfill {\sf\bfseries\slshape#1},~\emph{#2}\par
      \penalty\@highpenalty
    \endgroup
    \vskip\@lowerskip
  \fi}
\def\@dottedtocline#1#2#3#4#5{%
  \ifnum #1>\c@tocdepth \else
    \vskip \z@ \@plus.2\p@
    {\leftskip #2\relax \rightskip \@tocrmarg \parfillskip -\rightskip
     \parindent #2\relax\@afterindenttrue
     \interlinepenalty\@M
     \leavevmode
     \@tempdima #3\relax
     \advance\leftskip \@tempdima \null\nobreak\hskip -\leftskip
     {\hfill #4},~\emph{#5}\par}%
  \fi%
  \sectionlab{s@ctionlr-\arabic{sectionlr}}{#5}\stepcounter{sectionlr}}
\def\chapter@upper\uppercase
\def\@chapter[#1]#2{\ifnum \c@secnumdepth >\m@ne
                       \if@mainmatter
                         \refstepcounter{chapter}%
                         \typeout{\@chapapp\space\thechapter.}%
                         \addcontentsline{toc}{chapter}%
                                   {\protect\numberline{\thechapter}\chapter@upper{#1}}%
                       \else
                         \addcontentsline{toc}{chapter}{\chapter@upper{#1}}%
                       \fi
                    \else
                      \addcontentsline{toc}{chapter}{\chapter@upper{#1}}%
                    \fi
                    \chaptermark{#1}%
                    \addtocontents{lof}{\protect\addvspace{10\p@}}%
                    \addtocontents{lot}{\protect\addvspace{10\p@}}%
                    \if@twocolumn
                      \@topnewpage[\@makechapterhead{#2}]%
                    \else
                      \@makechapterhead{#2}%
                      \@afterheading
                    \fi}

\setcounter{tocdepth}{1}

% no indent after section start

\let\@afterindenttrue\@afterindentfalse
\@afterindentfalse

%% References style

\newenvironment{references}[1]
     {\section{References}%
      \list{\@biblabel{\@arabic\c@enumiv}}%
           {\settowidth\labelwidth{\@biblabel{#1}}%
            \leftmargin\labelwidth
            \advance\leftmargin\labelsep
            \@openbib@code
            \usecounter{enumiv}%
            \let\p@enumiv\@empty
            \renewcommand\theenumiv{\@arabic\c@enumiv}}%
      \sloppy
      \clubpenalty4000
      \@clubpenalty \clubpenalty
      \widowpenalty4000%
      \sfcode`\.\@m}
     {\def\@noitemerr
       {\@latex@warning{Empty `references' environment}}%
      \endlist
\setcounter{enumiv}{0}% references are counted per chapter
}

%% Forth ``logo''
%1984 edition spells ``FORTH''
\ifeightyfour
\def\Forth{FORTH}
\else
%1994 edition spells ``Forth''
\def\Forth{Forth}
\fi

%% Names are often typeset in small caps

\ifofour
\let\person\textsc
\else
\let\person\relax
\fi

\makeatother